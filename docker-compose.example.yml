services:
  # One-stack default: start go2rtc + WatchMyBirds together.
  # Uses host networking so WebRTC streaming works out of the box.
  go2rtc:
    image: alexxit/go2rtc:latest
    container_name: go2rtc
    restart: unless-stopped
    network_mode: host
    volumes:
      # Reuse the existing output folder.
      # go2rtc reads /config/go2rtc.yaml -> /your_path/output/go2rtc.yaml on host.
      - /your_path/output:/config

  watchmybirds:
    image: starminworks/watchmybirds:latest
    container_name: watchmybirds
    depends_on:
      go2rtc:
        condition: service_started
    restart: unless-stopped
    network_mode: host
    environment:
      # Camera source the user provides.
      - CAMERA_URL=rtsp://user:password@192.168.x.x:554/stream1
      # Recommended default: relay when available, direct fallback if not.
      - STREAM_SOURCE_MODE=auto # auto | relay | direct
      # go2rtc runs on the same host network.
      - GO2RTC_API_BASE=http://127.0.0.1:1984
      # Keep config in /output so no extra host mount is needed.
      - GO2RTC_CONFIG_PATH=/output/go2rtc.yaml
      # Paths
      - OUTPUT_DIR=/output
      - INGEST_DIR=/ingest
      - MODEL_BASE_PATH=/models
      # System
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
      - DEBUG_MODE=False
      # Optional tuning
      - STREAM_WIDTH_OUTPUT_RESIZE=640
      - STREAM_FPS=0
      - STREAM_FPS_CAPTURE=0
      - CONFIDENCE_THRESHOLD_DETECTION=0.55
      - SAVE_THRESHOLD=0.55
      - DETECTION_INTERVAL_SECONDS=2.0
      - CLASSIFIER_CONFIDENCE_THRESHOLD=0.55
      - DAY_AND_NIGHT_CAPTURE=True
      - DAY_AND_NIGHT_CAPTURE_LOCATION=Berlin
      - LOCATION_DATA="52.516, 13.377"
      - CPU_LIMIT=0
      - TELEGRAM_COOLDOWN=5
      - TELEGRAM_ENABLED=True
      - EDIT_PASSWORD=SECRET_PASSWORD
      # Telegram credentials (required if TELEGRAM_ENABLED=True)
      - TELEGRAM_BOT_TOKEN=your_token_here
      - TELEGRAM_CHAT_ID=your_chat_id_here
      - DETECTOR_MODEL_CHOICE=yolo
    volumes:
      - /your_path/output:/output
      - /your_path/ingest:/ingest
      - /your_path/models:/models

# If you intentionally want to run without go2rtc:
# - Remove go2rtc service.
# - Remove GO2RTC_API_BASE and GO2RTC_CONFIG_PATH from watchmybirds.
# - Set STREAM_SOURCE_MODE=direct.

# ── Optional: Bridge Network ──────────────────────────────────
# If you prefer Docker bridge networking (isolated ports),
# replace `network_mode: host` with the config below.
# Note: WebRTC may not work without extra STUN/TURN configuration.
#
#   1. Remove `network_mode: host` from both services
#   2. Add to both services:
#        networks:
#          - wmb_net
#   3. Add ports to go2rtc:
#        ports:
#          - "1984:1984"
#          - "8554:8554"
#          - "8555:8555/tcp"
#          - "8555:8555/udp"
#   4. Add ports to watchmybirds:
#        ports:
#          - "8050:8050"
#   5. Change GO2RTC_API_BASE to http://go2rtc:1984
#   6. Add at the bottom:
#        networks:
#          wmb_net:
#            driver: bridge
