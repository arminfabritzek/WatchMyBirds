name: Build DEV Image

on:
  workflow_dispatch:
    inputs:
      base_tag:
        description: 'Golden Image tag to use (e.g. golden-bookworm-v1.0.0)'
        required: false
        default: ''
  workflow_run:
    workflows: ["Build Golden Image"]
    types:
      - completed

jobs:
  build-dev:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write

    steps:
      - name: Checkout App Code
        uses: actions/checkout@v4
        with:
          path: app_code

      - name: Inject SSH Key from Secret
        run: |
          if [ -z "${{ secrets.DEV_SSH_PUBLIC_KEY }}" ]; then
            echo "::warning::Missing GitHub Secret 'DEV_SSH_PUBLIC_KEY'! SSH access to the DEV image will not be possible unless you add this secret."
            # Create empty file to ensure copy steps don't fail
            touch app_code/rpi/dev_authorized_keys
          else
            echo "${{ secrets.DEV_SSH_PUBLIC_KEY }}" > app_code/rpi/dev_authorized_keys
            echo "SSH key injected from secret"
          fi

      - name: Download Configured Golden Image
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ github.event.inputs.base_tag }}" ]; then
            LATEST_TAG="${{ github.event.inputs.base_tag }}"
          else
            # Get latest Golden Release tag
            LATEST_TAG=$(gh release list --repo ${{ github.repository }} --limit 10 --json tagName,isPrerelease,createdAt --jq 'sort_by(.createdAt) | reverse | .[] | select(.tagName | startswith("golden-bookworm")) | .tagName' | head -n 1)
          fi
          
          if [ -z "$LATEST_TAG" ]; then
            echo "::error::No Golden Image Release found!"
            exit 1
          fi
          
          echo "Downloading Golden Image: $LATEST_TAG"
          gh release download "$LATEST_TAG" --repo ${{ github.repository }} --pattern "golden.img.xz"

      - name: Decompress Image
        run: |
          if [ -f golden.img.xz ]; then
            unxz golden.img.xz
          else
            echo "::error::Golden Image file missing!"
            exit 1
          fi

      - name: Create Wheelhouse (Host)
        run: |
          mkdir -p wheelhouse
          pip download \
            -r app_code/requirements.txt \
            --dest ./wheelhouse \
            --platform manylinux2014_aarch64 \
            --python-version 3.11 \
            --only-binary=:all: \
            --extra-index-url https://www.piwheels.org/simple

      - name: Install QEMU
        run: sudo apt-get update && sudo apt-get install -y qemu-user-static

      - name: Mount and Inject App (DEV MODE)
        run: |
          set -euo pipefail
          
          mkdir -p mount_point
          LOOP_DEV=$(sudo losetup --find --show --partscan golden.img)
          
          sudo mount ${LOOP_DEV}p2 mount_point
          sudo mount ${LOOP_DEV}p1 mount_point/boot/firmware

          # Copy QEMU
          sudo cp /usr/bin/qemu-aarch64-static mount_point/usr/bin/

          # Inject App Code
          sudo mkdir -p mount_point/opt/app
          sudo rsync -av --delete --exclude='.git' --exclude='.github' app_code/ mount_point/opt/app/

          # Inject Wheelhouse
          sudo mkdir -p mount_point/opt/wheelhouse
          sudo cp -r wheelhouse/* mount_point/opt/wheelhouse/

          # Write Version Metadata
          echo "dev-${{ github.sha }}" | sudo tee mount_point/opt/app/version.txt
          echo "${{ github.sha }}" | sudo tee mount_point/opt/app/commit.txt

          # Copy DEV hardening resources
          sudo mkdir -p mount_point/tmp/systemd
          sudo mkdir -p mount_point/tmp/first-boot
          sudo mkdir -p mount_point/tmp/ap
          sudo mkdir -p mount_point/tmp/setup-server/templates
          
          sudo cp app_code/rpi/systemd/* mount_point/tmp/systemd/
          sudo cp app_code/rpi/first-boot/* mount_point/tmp/first-boot/
          sudo cp app_code/rpi/ap/* mount_point/tmp/ap/
          sudo cp app_code/rpi/setup-server/*.py mount_point/tmp/setup-server/
          sudo cp app_code/rpi/setup-server/templates/* mount_point/tmp/setup-server/templates/
          
          # Copy SSH key for admin
          sudo cp app_code/rpi/dev_authorized_keys mount_point/tmp/dev_authorized_keys

          # Bind Mounts for Chroot (Required for systemd-tmpfiles and apt-get)
          sudo mount --bind /dev mount_point/dev
          sudo mount --bind /dev/pts mount_point/dev/pts
          sudo mount --bind /sys mount_point/sys
          sudo mount --bind /proc mount_point/proc
          sudo mount --bind /etc/resolv.conf mount_point/etc/resolv.conf

          # Run DEV hardening (NOT production harden.sh!)
          sudo cp app_code/rpi/harden-dev.sh mount_point/tmp/harden-dev.sh
          sudo chmod +x mount_point/tmp/harden-dev.sh
          sudo chroot mount_point /tmp/harden-dev.sh
          sudo rm mount_point/tmp/harden-dev.sh
          
          # Cleanup temp files
          sudo rm -rf mount_point/tmp/systemd mount_point/tmp/first-boot mount_point/tmp/ap mount_point/tmp/setup-server mount_point/tmp/dev_authorized_keys

          # Fix Permissions (DEV: Give /opt/app to admin for seamless rsync)
          sudo chroot mount_point chown -R admin:admin /opt/app

          # Install DEV service (relaxed security)
          sudo cp mount_point/opt/app/systemd/app-dev.service mount_point/etc/systemd/system/app.service
          sudo ln -sf /etc/systemd/system/app.service mount_point/etc/systemd/system/multi-user.target.wants/app.service

          # Update First-Boot Script & Service
          sudo cp mount_point/opt/app/rpi/first-boot/first-boot.sh mount_point/usr/local/bin/wmb-first-boot.sh
          sudo chmod 755 mount_point/usr/local/bin/wmb-first-boot.sh
          sudo cp mount_point/opt/app/rpi/systemd/wmb-first-boot.service mount_point/etc/systemd/system/
          sudo ln -sf /etc/systemd/system/wmb-first-boot.service mount_point/etc/systemd/system/multi-user.target.wants/wmb-first-boot.service

          # Install WiFi Setup System
          sudo cp mount_point/opt/app/rpi/first-boot/setup_wifi.sh mount_point/usr/local/bin/wmb-setup-wifi.sh
          sudo chmod 755 mount_point/usr/local/bin/wmb-setup-wifi.sh
          
          sudo cp mount_point/opt/app/rpi/systemd/wmb-wifi-setup.service mount_point/etc/systemd/system/
          sudo cp mount_point/opt/app/rpi/systemd/wmb-wifi-setup.path mount_point/etc/systemd/system/
          sudo cp mount_point/opt/app/rpi/systemd/wmb-setup-server.service mount_point/etc/systemd/system/
          
           # Install Watchdog
          sudo cp mount_point/opt/app/rpi/systemd/wmb-wifi-watchdog.sh mount_point/usr/local/bin/wmb-wifi-watchdog.sh
          sudo chmod 755 mount_point/usr/local/bin/wmb-wifi-watchdog.sh
          sudo cp mount_point/opt/app/rpi/systemd/wmb-wifi-watchdog.service mount_point/etc/systemd/system/
          sudo cp mount_point/opt/app/rpi/systemd/wmb-wifi-watchdog.timer mount_point/etc/systemd/system/

          sudo cp mount_point/opt/app/rpi/setup-server/setup_server.py mount_point/usr/local/bin/wmb-setup-server.py
          sudo chmod 755 mount_point/usr/local/bin/wmb-setup-server.py
          sudo mkdir -p mount_point/usr/local/share/watchmybirds/setup/templates
          sudo cp mount_point/opt/app/rpi/setup-server/templates/setup.html mount_point/usr/local/share/watchmybirds/setup/templates/setup.html
          
          sudo ln -sf /etc/systemd/system/wmb-wifi-setup.path mount_point/etc/systemd/system/multi-user.target.wants/wmb-wifi-setup.path

          # Install Dependencies
          sudo chroot mount_point /bin/bash -c "
            set -ex
            python3 -m venv /opt/app/.venv
            /opt/app/.venv/bin/pip install --no-index --find-links /opt/wheelhouse -r /opt/app/requirements.txt
            rm -rf /opt/wheelhouse
          "
          
          # Cleanup
          sudo umount mount_point/etc/resolv.conf
          sudo umount mount_point/sys
          sudo umount mount_point/proc
          sudo umount mount_point/dev/pts || true
          sudo umount mount_point/dev
          sudo rm mount_point/usr/bin/qemu-aarch64-static
          
          sudo umount mount_point/boot/firmware
          sudo umount mount_point
          sudo losetup -d $LOOP_DEV

      - name: Rename Image
        run: |
          DATE=$(date +%Y-%m-%d)
          mv golden.img watchmybirds-rpi-dev-${DATE}.img

      - name: Compress DEV Image
        run: |
          DATE=$(date +%Y-%m-%d)
          xz -z -1 -T0 watchmybirds-rpi-dev-${DATE}.img

      - name: Create DEV Release and Upload
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +%Y-%m-%d)
          TAG="rpi-dev-${DATE}"
          IMG_FILE="watchmybirds-rpi-dev-${DATE}.img.xz"
          
          # Create Release if not exists
          gh release view "$TAG" --repo "${{ github.repository }}" >/dev/null 2>&1 || \
            gh release create "$TAG" \
              --repo "${{ github.repository }}" \
              --title "üçì Raspberry Pi Dev Image ‚Äì ${DATE}" \
              --notes "## WatchMyBirds Raspberry Pi Development Image\n\n**Build Date:** ${DATE}\n**Commit:** ${{ github.sha }}\n\n‚ö†Ô∏è **Development build** ‚Äì SSH enabled, relaxed security for testing.\n\nFlash to SD card with [Raspberry Pi Imager](https://www.raspberrypi.com/software/) and boot on Raspberry Pi 5." \
              --prerelease

          # Upload Asset
          echo "Uploading $IMG_FILE to release $TAG..."
          gh release upload "$TAG" \
            "$IMG_FILE" \
            --repo "${{ github.repository }}" \
            --clobber
