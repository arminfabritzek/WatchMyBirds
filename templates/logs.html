{% extends "base.html" %}

{% block title %}System Logs - WatchMyBirds{% endblock %}

{% block head %}
{# Styles migrated to design-system.css: LOGS PAGE section #}
{% endblock %}

{% block content %}
{# Page Header #}
<div class="page__header">
    <h1 class="page__title">System Logs</h1>
    <div class="page__actions">
        <button onclick="window.location.reload()" class="btn btn--secondary">Refresh</button>
    </div>
</div>

{# Log Card #}
<div class="card">
    <div class="card__header" style="display: flex; justify-content: space-between; align-items: center;">
        <span class="font-mono text-sm text-muted">/var/lib/watchmybirds/logs/app.log</span>
        <div id="filter-controls" style="display: flex; gap: var(--space-xs);">
            <button class="filter-btn active" data-level="INFO">INFO</button>
            <button class="filter-btn active" data-level="WARNING">WARN</button>
            <button class="filter-btn active" data-level="ERROR">ERROR</button>
        </div>
    </div>
    <div class="card__body" style="padding: 0;">
        <pre id="log-content" class="log-viewer">{{ logs }}</pre>
    </div>
    <div class="card__footer" style="display: flex; justify-content: space-between;">
        <span class="text-sm text-muted">Showing last 200 lines</span>
        <span id="line-count" class="text-sm text-muted"></span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const logContent = document.getElementById('log-content');
        const originalLogs = logContent.textContent;
        const lines = originalLogs.split('\n');

        function processLogs() {
            let html = '';
            let count = 0;

            const activeLevels = Array.from(document.querySelectorAll('.filter-btn.active'))
                .map(btn => btn.getAttribute('data-level'));

            lines.forEach(line => {
                if (!line.trim()) return;

                let level = 'INFO';
                if (line.includes(' - WARNING - ')) level = 'WARNING';
                else if (line.includes(' - ERROR - ')) level = 'ERROR';
                else if (line.includes(' - DEBUG - ')) level = 'DEBUG';

                if (activeLevels.includes(level) || (level === 'DEBUG' && activeLevels.includes('INFO'))) {
                    let formatted = line
                        .replace(/[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2},[0-9]{3}/, '<span class="log-timestamp">$&</span>')
                        .replace(new RegExp(` - ${level} - `), ` - <span class="log-${level.toLowerCase()}">${level}</span> - `);

                    html += `<div>${formatted}</div>`;
                    count++;
                }
            });

            logContent.innerHTML = html || '<div class="text-muted">No logs found matching filters.</div>';
            document.getElementById('line-count').textContent = count + ' lines displayed';
            logContent.scrollTop = logContent.scrollHeight;
        }

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('active');
                processLogs();
            });
        });

        processLogs();
    });
</script>
{% endblock %}