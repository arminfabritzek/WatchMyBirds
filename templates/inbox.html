{% extends 'base.html' %}

{% block title %}Upload Images - WatchMyBirds{% endblock %}

{% block content %}
{# Simple Header #}
<div class="page__header">
    <h1 class="page__title">üì∑ Upload Images</h1>
</div>

{# Upload Dropzone - Clean & Simple #}
<div class="card">
    <div class="card__body">
        <div class="dropzone" id="dropzone" onclick="document.getElementById('fileInput').click()">
            <div class="dropzone__icon">üì∑</div>
            <div class="dropzone__text">Drag images here</div>
            <div class="dropzone__hint">or click to select</div>
        </div>
        <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png" style="display: none">

        <div id="fileList" class="mt-md"></div>

        <button id="uploadBtn" class="btn btn--primary btn--lg btn--block mt-md hidden">
            <span id="uploadBtnText">‚¨ÜÔ∏è Upload</span>
            <span id="uploadSpinner" class="animate-spin hidden" style="margin-left: 8px;">‚ü≥</span>
        </button>

        <div id="uploadResult" class="mt-md hidden"></div>
    </div>
</div>

{# Status - Compact #}
<div id="statusSection" class="mt-lg">
    <div class="grid grid--2">
        <div class="stat-card">
            <div class="stat-card__value" id="pendingCount">-</div>
            <div class="stat-card__label">Pending</div>
        </div>
        <div class="stat-card">
            <div class="stat-card__value" id="processedToday">-</div>
            <div class="stat-card__label">Processed</div>
        </div>
    </div>
</div>

{# Process Button - only if there are pending files #}
<div id="processSection" class="mt-lg hidden">
    <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
        <label for="batchSize" style="font-weight: 600; white-space: nowrap;">Batch size:</label>
        <select id="batchSize" class="form-control"
            style="flex: 1; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--color-border); background: var(--color-surface-2); font-size: 15px;">
            <option value="100">100</option>
            <option value="250">250</option>
            <option value="500">500</option>
            <option value="1000">1000</option>
            <option value="0" selected>All</option>
        </select>
    </div>
    <button id="processBtn" class="btn btn--accent btn--lg btn--block" onclick="startProcessing()">
        <span id="processBtnText">‚ú® Process Now</span>
    </button>
    <p id="processHint" class="text-center text-muted text-sm mt-sm"></p>
    <div id="processResult" class="mt-md"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedFiles = [];

    document.addEventListener('DOMContentLoaded', function () {
        initDropzone();
        updateStatus();
        setInterval(updateStatus, 5000);
    });

    function initDropzone() {
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover'].forEach(evt => {
            dropzone.addEventListener(evt, e => {
                e.preventDefault();
                dropzone.classList.add('active');
            });
        });

        ['dragleave', 'drop'].forEach(evt => {
            dropzone.addEventListener(evt, e => {
                e.preventDefault();
                dropzone.classList.remove('active');
            });
        });

        dropzone.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
        fileInput.addEventListener('change', e => handleFiles(e.target.files));
    }

    function handleFiles(fileList) {
        // Filter for images (jpg, png) and size limit (50MB)
        const validExtensions = ['.jpg', '.jpeg', '.png'];
        const currentFiles = Array.from(fileList);

        let rejectedCount = 0;

        currentFiles.forEach(file => {
            const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
            if (!validExtensions.includes(ext)) {
                rejectedCount++;
                return;
            }
            if (file.size > 50 * 1024 * 1024) { // 50MB limit
                rejectedCount++;
                return;
            }
            selectedFiles.push(file);
        });

        if (rejectedCount > 0) {
            alert(`Skipped ${rejectedCount} invalid file(s). Only JPG/PNG images under 50MB are allowed.`);
        }

        renderFileList();
    }

    function renderFileList() {
        const container = document.getElementById('fileList');
        const uploadBtn = document.getElementById('uploadBtn');

        if (selectedFiles.length === 0) {
            container.innerHTML = '';
            uploadBtn.classList.add('hidden');
            return;
        }

        uploadBtn.classList.remove('hidden');

        // Show summary for large batches, details for small
        if (selectedFiles.length > 20) {
            const totalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
            container.innerHTML = `
                <div style="padding: 12px; background: var(--color-surface-2); border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 600; color: var(--color-primary);">${selectedFiles.length}</div>
                    <div style="color: var(--color-text-muted);">images selected (${formatSize(totalSize)})</div>
                </div>
            `;
        } else {
            container.innerHTML = selectedFiles.map(file => `
                <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--color-surface-2); border-radius: 8px; margin-bottom: 4px;">
                    <span style="font-size: 14px;">${file.name}</span>
                    <span style="color: var(--color-text-muted); font-size: 13px;">${formatSize(file.size)}</span>
                </div>
            `).join('');
        }
    }

    function formatSize(bytes) {
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(0) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    document.getElementById('uploadBtn').addEventListener('click', startUpload);

    // Chunked upload - 50 files per request
    const CHUNK_SIZE = 50;

    async function startUpload() {
        if (selectedFiles.length === 0) return;

        const btn = document.getElementById('uploadBtn');
        const btnText = document.getElementById('uploadBtnText');
        const spinner = document.getElementById('uploadSpinner');
        const result = document.getElementById('uploadResult');

        btn.disabled = true;
        spinner.classList.remove('hidden');
        result.classList.add('hidden');

        // Split into chunks
        const chunks = [];
        for (let i = 0; i < selectedFiles.length; i += CHUNK_SIZE) {
            chunks.push(selectedFiles.slice(i, i + CHUNK_SIZE));
        }

        let totalUploaded = 0;
        let totalSkipped = 0;
        let totalErrors = 0;

        try {
            for (let i = 0; i < chunks.length; i++) {
                btnText.textContent = `Batch ${i + 1}/${chunks.length}...`;

                const formData = new FormData();
                chunks[i].forEach(file => formData.append('files[]', file));

                const response = await fetch('/api/inbox', { method: 'POST', body: formData });
                const data = await response.json();

                if (response.ok) {
                    totalUploaded += data.uploaded?.length || 0;
                    totalSkipped += data.skipped_count || 0;
                    totalErrors += data.errors?.length || 0;
                } else {
                    totalErrors += chunks[i].length;
                }
            }

            // Build result message
            let msg = `‚úÖ ${totalUploaded} image(s) uploaded!`;
            if (totalSkipped > 0) {
                msg += ` (${totalSkipped} skipped - already exists)`;
            }
            if (totalErrors > 0) {
                msg += ` (${totalErrors} error(s))`;
            }
            result.innerHTML = `<div class="alert alert--success">${msg}</div>`;
            result.classList.remove('hidden');

            selectedFiles = [];
            renderFileList();
            updateStatus();

        } catch (err) {
            result.innerHTML = `<div class="alert alert--danger">‚ùå Connection error</div>`;
            result.classList.remove('hidden');
        } finally {
            btn.disabled = false;
            btnText.textContent = '‚¨ÜÔ∏è Upload';
            spinner.classList.add('hidden');
        }
    }

    async function updateStatus() {
        try {
            const response = await fetch('/api/inbox/status');
            const data = await response.json();

            document.getElementById('pendingCount').textContent = data.pending_count ?? 0;
            document.getElementById('processedToday').textContent = data.processed_today ?? 0;

            const processSection = document.getElementById('processSection');
            const processBtn = document.getElementById('processBtn');
            const processBtnText = document.getElementById('processBtnText');
            const processHint = document.getElementById('processHint');

            if ((data.pending_count ?? 0) > 0) {
                processSection.classList.remove('hidden');

                if (data.processing) {
                    processBtn.disabled = true;
                    processBtnText.textContent = '‚è≥ Processing...';
                } else {
                    processBtn.disabled = false;
                    processBtn.onclick = startProcessing;
                    processBtnText.textContent = '‚ú® Process Now';
                }
            } else {
                processSection.classList.add('hidden');
            }
        } catch (err) {
            console.error('Status error:', err);
        }
    }

    async function startProcessing() {
        const btn = document.getElementById('processBtn');
        const text = document.getElementById('processBtnText');
        const result = document.getElementById('processResult');

        btn.disabled = true;
        text.textContent = '‚è≥ Starting...';
        result.innerHTML = '';

        try {
            const batchSize = parseInt(document.getElementById('batchSize').value) || 0;
            const response = await fetch('/api/inbox/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ batch_size: batchSize })
            });
            const data = await response.json();

            if (response.ok) {
                result.innerHTML = `<div class="alert alert--success">‚úÖ Processing started!</div>`;
            } else {
                result.innerHTML = `<div class="alert alert--danger">‚ùå ${data.error || 'Error'}</div>`;
            }
        } catch (err) {
            result.innerHTML = `<div class="alert alert--danger">‚ùå Connection error</div>`;
        } finally {
            updateStatus();
        }
    }
</script>
{% endblock %}