{% extends 'base.html' %}

{% block title %}Live Stream - WatchMyBirds{% endblock %}

{% block head %}
{# Styles migrated to design-system.css: STREAM PAGE section #}
{% endblock %}

{% block content %}
{# Page Header #}
<div class="page__header">
    <h1 class="page__title">{{ title }}</h1>
</div>

{# Live Stream #}
<div class="stream-wrapper">
    <div class="stream-container">
        <img id="video-feed" src="/video_feed" class="stream-video" alt="Live Stream">

        {# Redundant timestamp removed to prevent overlap with camera overlay #}

        {# PTZ Controls (on hover) #}
        <div class="ptz-overlay">
            <div class="ptz-dpad">
                <div></div>
                <button class="ptz-btn" id="ptz-up" title="Tilt Up" disabled>â–²</button>
                <div></div>
                <button class="ptz-btn" id="ptz-left" title="Pan Left" disabled>â—€</button>
                <button class="ptz-btn center-btn" id="ptz-home" title="Home" disabled>âŒ‚</button>
                <button class="ptz-btn" id="ptz-right" title="Pan Right" disabled>â–¶</button>
                <div></div>
                <button class="ptz-btn" id="ptz-down" title="Tilt Down" disabled>â–¼</button>
                <div></div>
            </div>

            <div class="ptz-zoom">
                <button class="ptz-btn" id="ptz-zoom-out" title="Zoom Out" disabled>âˆ’</button>
                <input type="range" id="ptz-zoom-slider" min="1" max="10" value="1" disabled>
                <button class="ptz-btn" id="ptz-zoom-in" title="Zoom In" disabled>+</button>
            </div>

            <button class="ptz-btn" id="ptz-snapshot" title="Snapshot">ðŸ“·</button>
            <button class="ptz-btn" id="ptz-fullscreen" title="Fullscreen">â›¶</button>
        </div>
    </div>
</div>

{# Dashboard Stats Row - Engagement Elements #}
{% if dashboard_stats %}
<div class="stats-row">
    <div class="stat-item">
        <div class="stat-item__value">{{ dashboard_stats.total_detections | default(0) }}</div>
        <div class="stat-item__label">Total Detections</div>
    </div>
    <div class="stat-item stat-item--accent">
        <div class="stat-item__value">{{ dashboard_stats.total_species | default(0) }}</div>
        <div class="stat-item__label">Species Detected</div>
    </div>
    <div class="stat-item stat-item--secondary">
        <div class="stat-item__value">{{ dashboard_stats.today_count | default(0) }}</div>
        <div class="stat-item__label">Today's Count</div>
    </div>
    <div class="stat-item stat-item--warning">
        <div class="stat-item__value">{{ dashboard_stats.first_date | default('â€”') }}</div>
        <div class="stat-item__label">Monitoring Since</div>
    </div>
</div>
{% endif %}

{# Today's Summary - British Bird Humor when empty #}
<section class="section">
    {% if visual_summary %}
    <h2 class="section__title">Today's Summary</h2>
    <div class="species-grid">
        {% for det in visual_summary %}
        <div class="wm-tile" data-detection-id="{{ det.detection_id }}">
            <a class="wm-tile__button"
                href="/species/overview?species_key={{ (det.species_key or det.latin_name or 'Unclassified') | urlencode }}"
                style="text-decoration:none;color:inherit;" aria-label="Show all detections: {{ det.common_name }}">
                <div class="wm-tile__media">
                    <img class="wm-tile__image" src="{{ det.display_path }}" alt="{{ det.common_name }}">

                    {% if det.count %}
                    <span class="wm-tile__badge">{{ det.count }}</span>
                    {% endif %}
                </div>
                <div class="wm-tile__body">
                    <span class="wm-tile__name">{{ det.common_name }}</span>
                    {% if det.latin_name %}
                    <span class="wm-tile__latin">{{ det.latin_name | replace('_', ' ') }}</span>
                    {% endif %}
                </div>
            </a>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <h2 class="section__title">A Rather Quiet Day at the Feeder</h2>
    <div class="empty-state">
        <p class="empty-state__message">The birds appear to be having a lie-in today.</p>
        <p class="empty-state__message">In the meantime, <a href="/species">browse past visitors</a> â€” we're always
            happy to see whatever pops by!</p>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        // Snapshot
        document.getElementById('ptz-snapshot').addEventListener('click', function () {
            const filename = 'snapshot_' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.jpg';
            fetch('/api/snapshot')
                .then(r => r.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                })
                .catch(() => alert('Snapshot failed'));
        });

        // Fullscreen
        document.getElementById('ptz-fullscreen').addEventListener('click', function () {
            const el = document.querySelector('.stream-container');
            if (el.requestFullscreen) el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        });
    })();
</script>
{% endblock %}