{#
Detection Detail Modal (UI_STANDARD.md compliant)

Combines reusable components for consistent modal rendering.
Used in gallery views to show detection details.

Args:
det (dict): Detection object with all data
group_id (str): Modal group for navigation isolation
#}
{% from "components/modal_image_viewer.html" import render_image_viewer %}
{% from "components/modal_action_bar.html" import render_action_bar %}
{% from "components/modal_detection_info.html" import render_detection_info %}

{% macro render_modal(det, group_id) %}
<div class="modal fade gallery-modal wm-modal" id="modal-{{ group_id }}-{{ det.detection_id }}" tabindex="-1"
    aria-hidden="true" data-modal-group="{{ group_id }}" data-image-path="{{ det.full_path }}">

    <div
        class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable modal-fullscreen-md-down wm-modal__dialog">
        <div class="modal-content wm-modal__content">

            <div class="modal-header wm-modal__header">
                <div class="wm-modal__title">
                    {% set wiki_url = wikipedia_species_url(det.common_name, det.cls_class_name or det.od_class_name) %}
                    {% if wiki_url %}
                    <a class="wm-modal__title-text" href="{{ wiki_url }}" target="_blank"
                        rel="noopener noreferrer nofollow external"
                        title="Open Wikipedia (new tab): {{ det.common_name }}"
                        aria-label="Open Wikipedia (new tab): {{ det.common_name }}"><em>{{ det.common_name }}</em>
                        <span aria-hidden="true">↗</span></a>
                    {% else %}
                    <span class="wm-modal__title-text"><em>{{ det.common_name }}</em></span>
                    {% endif %}
                    <span class="wm-modal__title-sub">{{ det.formatted_date }} {{ det.formatted_time }}{% if
                        det.cls_class_name or det.od_class_name %} · <em>{{ (det.cls_class_name or det.od_class_name)
                            | replace('_', ' ') }}</em>{% endif %}</span>
                </div>
                <button type="button" class="btn-close wm-modal__close" data-bs-dismiss="modal"></button>
            </div>

            <div class="wm-modal__body">
                <div class="wm-modal__image">
                    {{ render_image_viewer(
                    image_url=det.full_path,
                    image_alt=det.common_name,
                    detection_id=det.detection_id,
                    bbox={'x': det.bbox_x, 'y': det.bbox_y, 'w': det.bbox_w, 'h': det.bbox_h},
                    dismissable=true
                    ) }}
                </div>
                <div class="wm-modal__info">
                    {{ render_detection_info(
                    det=det,
                    siblings=det.siblings,
                    sibling_count=det.sibling_count
                    ) }}
                </div>
            </div>

            <div class="wm-modal__action">
                {{ render_action_bar(
                detection_id=det.detection_id,
                original_url=det.original_path,
                bbox={
                'x': det.bbox_x,
                'y': det.bbox_y,
                'w': det.bbox_w,
                'h': det.bbox_h,
                'name': det.common_name,
                'id': det.detection_id
                },
                siblings=det.siblings,
                show_nav=true,
                show_bbox_toggle=true,
                show_trash=true,
                show_download=true,
                gallery_date=det.gallery_date,
                is_favorite=det.is_favorite
                ) }}
            </div>

        </div>
    </div>
</div>
{% endmacro %}