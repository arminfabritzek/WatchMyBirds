{% extends 'base.html' %}

{% block title %}{{ date }} - Gallery - WatchMyBirds{% endblock %}

{% block head %}
{# Styles migrated to design-system.css: GALLERY GRID and PAGINATION sections #}
{% endblock %}

{% block content %}
<nav class="page-control-bar" role="navigation" aria-label="Gallery controls">
    <div class="page-control-bar__left">
        <span class="page-control-bar__title">{{ date }}</span>
    </div>
    <div class="page-control-bar__center">
        {% include 'partials/filter_bar.html' %}
    </div>
    <div class="page-control-bar__meta">
        Page {{ page }} of {{ total_pages }} ({{ total_items }} items)
    </div>
    <div class="page-control-bar__right">
        <a href="/edit/{{ date }}" class="btn btn--secondary">Edit</a>
        <a href="/gallery" class="btn btn--secondary">← Gallery</a>
    </div>
</nav>

{# Species of the Day (Page 1 only) #}
{% if page == 1 and species_of_day %}
<section class="section">
    <h2 class="section__title">Species of the Day</h2>
    <div class="gallery-grid">
        {% for det in species_of_day %}
        <div class="wm-tile" data-detection-id="{{ det.detection_id }}">
            <button type="button" class="wm-tile__button" data-bs-toggle="modal"
                data-bs-target="#modal-species-{{ det.detection_id }}">

                <div class="wm-tile__media">
                    <img class="wm-tile__image" src="{{ det.display_url }}" alt="{{ det.common_name }}">
                </div>
            </button>

            <div class="wm-tile__body">
                <span class="wm-tile__name">{{ det.common_name }}</span>
                {% if det.cls_class_name or det.od_class_name %}
                <span class="wm-tile__latin">{{ (det.cls_class_name or det.od_class_name) | replace('_', ' ') }}</span>
                {% endif %}
                <span class="wm-tile__score">{{ "%.2f"|format(det.score) }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

{# Main Gallery Grid #}
<section class="section">
    <h2 class="section__title">All Observations</h2>
    <div class="gallery-grid" id="subgallery-grid">
        {% for det in detections %}
        <div class="wm-tile" id="detection-{{ det.detection_id }}" data-detection-id="{{ det.detection_id }}">
            <button type="button" class="wm-tile__button" data-bs-toggle="modal"
                data-bs-target="#modal-main-{{ det.detection_id }}">

                <div class="wm-tile__media">
                    <img class="wm-tile__image" src="{{ det.display_url }}" alt="{{ det.common_name }}">
                </div>
            </button>

            <div class="wm-tile__body">
                <span class="wm-tile__name">{{ det.common_name }}</span>
                {% if det.cls_class_name or det.od_class_name %}
                <span class="wm-tile__latin">{{ (det.cls_class_name or det.od_class_name) | replace('_', ' ') }}</span>
                {% endif %}
                <span class="wm-tile__score">{{ "%.2f"|format(det.score) }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</section>

{# Pagination #}
{% if total_pages > 1 %}
<nav class="pagination-wrapper" aria-label="Gallery pagination">
    <ul class="pagination">
        {% if page > 1 %}
        <li><a href="/gallery/{{ date }}?page={{ page - 1 }}&sort={{ sort_by }}&min_score={{ current_threshold }}">«</a>
        </li>
        {% endif %}

        {% for p in pagination_range %}
        {% if p == '...' %}
        <li class="disabled"><span>…</span></li>
        {% elif p == page %}
        <li class="active"><span>{{ p }}</span></li>
        {% else %}
        <li><a href="/gallery/{{ date }}?page={{ p }}&sort={{ sort_by }}&min_score={{ current_threshold }}">{{ p }}</a>
        </li>
        {% endif %}
        {% endfor %}

        {% if page < total_pages %} <li><a
                href="/gallery/{{ date }}?page={{ page + 1 }}&sort={{ sort_by }}&min_score={{ current_threshold }}">»</a>
            </li>
            {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}

{% block modals %}
{% from "components/detection_modal.html" import render_modal %}

{# Species Modals #}
{% for det in species_of_day %}
{{ render_modal(det, 'species') }}
{% endfor %}

{# Main Modals #}
{% for det in detections %}
{{ render_modal(det, 'main') }}
{% endfor %}
{% endblock %}

{% block scripts %}
<script src="/assets/js/gallery_utils.js"></script>
<script>
    // Scroll to detection if navigated via anchor hash
    document.addEventListener('DOMContentLoaded', function () {
        if (window.location.hash) {
            const targetId = window.location.hash.substring(1);
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
                setTimeout(() => {
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Highlight effect
                    targetEl.style.outline = '3px solid var(--color-primary)';
                    targetEl.style.outlineOffset = '2px';
                    setTimeout(() => {
                        targetEl.style.outline = '';
                        targetEl.style.outlineOffset = '';
                    }, 2000);
                }, 100);
            }
        }
    });
</script>
{% endblock %}