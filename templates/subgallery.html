{% extends 'base.html' %}

{% block title %}{{ date }} - Gallery - WatchMyBirds{% endblock %}

{% block head %}
{# Styles migrated to design-system.css: GALLERY GRID and PAGINATION sections #}
{% endblock %}

{% block content %}
<nav class="page-control-bar" role="navigation" aria-label="Gallery controls">
    <div class="page-control-bar__left">
        <span class="page-control-bar__title">{{ date }}</span>
    </div>
    <div class="page-control-bar__center">
        {% include 'partials/filter_bar.html' %}
    </div>
    <div class="page-control-bar__meta">
        Page {{ page }} of {{ total_pages }} ({{ total_items }} observation{{ 's' if total_items != 1 }}{% if
        total_items_unfiltered > total_items %} /
        {{ total_items_unfiltered }} total{% endif %})
    </div>
    <div class="page-control-bar__right">
        {% include 'partials/thumb_view_toggle.html' %}
        <button type="button" class="btn btn--secondary inline-edit-toggle" onclick="toggleInlineEdit(this)">‚úèÔ∏è
            Edit</button>
        <a href="/edit/{{ date }}" class="btn btn--secondary">Batch Edit</a>
        <a href="/gallery" class="btn btn--secondary">‚Üê Gallery</a>
    </div>
</nav>

{# Species of the Day (Page 1 only) #}
{% if page == 1 and species_of_day %}
<section class="section">
    <h2 class="section__title">Species of the Day</h2>
    <div class="gallery-grid">
        {% for det in species_of_day %}
        <div class="wm-tile fade-in-item" data-detection-id="{{ det.detection_id }}">
            <div class="wm-tile__media">
                <button type="button" class="wm-tile__button" data-bs-toggle="modal"
                    data-bs-target="#modal-species-{{ det.detection_id }}" style="height:100%; display:block;">
                    <img class="wm-tile__image" loading="lazy" src="{{ det.display_url }}" alt="{{ det.common_name }}"
                        data-thumb-src="{{ det.display_url }}" data-full-src="{{ det.full_url }}">
                </button>
                {% include 'partials/rating_badge.html' %}
            </div>

            <div class="wm-tile__body">
                <span class="wm-tile__name">{{ det.common_name }}</span>
                {% if det.cls_class_name or det.od_class_name %}
                <span class="wm-tile__latin">{{ (det.cls_class_name or det.od_class_name) | replace('_', ' ') }}</span>
                {% endif %}
                <span class="wm-tile__score">{{ "%.2f"|format(det.score) }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

{# Main Gallery Grid ‚Äî Observation Tiles #}
<section class="section">
    <h2 class="section__title">All Observations</h2>
    <div class="gallery-grid" id="subgallery-grid">
        {% for obs in observations %}
        {# ‚îÄ‚îÄ Observation tile (standard wm-tile, clickable ‚Üí expands filmstrip) ‚îÄ‚îÄ #}
        <div class="wm-tile fade-in-item" id="observation-{{ obs.observation_id }}"
            data-obs-id="{{ obs.observation_id }}" onclick="toggleObsFilmstrip(this)" style="cursor:pointer;">
            <div class="wm-tile__media">
                <img class="wm-tile__image" loading="lazy" src="{{ obs.cover_detection.display_url }}"
                    alt="{{ obs.common_name }}">
                {% if obs.photo_count > 1 %}
                <span class="wm-tile__badge" title="{{ obs.photo_count }} photos in this observation">üì∏ {{
                    obs.photo_count }}</span>
                {% endif %}
            </div>
            <div class="wm-tile__body">
                <span class="wm-tile__name">{{ obs.common_name }}</span>
                <span class="wm-tile__meta">{{ obs.cover_detection.formatted_time }}{% if obs.duration_sec > 0 %} ¬∑ {{
                    obs.duration_display }}{% endif %}</span>
                <span class="wm-tile__score">{{ "%.2f"|format(obs.best_score) }}{% if obs.photo_count > 1 %} <span
                        class="obs-card__expand-hint">‚ñº</span>{% endif %}</span>
            </div>
        </div>

        {# ‚îÄ‚îÄ Hidden filmstrip (all photos in this observation) ‚îÄ‚îÄ #}
        <div class="obs-filmstrip" id="filmstrip-{{ obs.observation_id }}" style="display:none;">
            <div class="obs-filmstrip__header">
                <span class="obs-filmstrip__title">{{ obs.common_name }} ‚Äî {{ obs.photo_count }} photo{{ 's' if
                    obs.photo_count != 1 }}</span>
                {% if obs.cover_detection.formatted_time %}
                <span class="obs-filmstrip__time">{{ obs.cover_detection.formatted_time }}{% if obs.duration_sec > 0 %}
                    ¬∑ {{ obs.duration_display }}{% endif %}</span>
                {% endif %}
                <button type="button" class="btn btn--sm btn--secondary obs-filmstrip__close"
                    onclick="event.stopPropagation(); closeFilmstrip('{{ obs.observation_id }}')">‚úï Close</button>
            </div>
            <div class="obs-filmstrip__grid">
                {% for det in obs.all_detections %}
                <div class="obs-filmstrip__item" data-detection-id="{{ det.detection_id }}">
                    <button type="button" class="obs-filmstrip__button" data-bs-toggle="modal"
                        data-bs-target="#modal-obs{{ obs.observation_id }}-{{ det.detection_id }}">
                        <img class="obs-filmstrip__thumb" loading="lazy" src="{{ det.display_url }}"
                            alt="{{ det.common_name }}">
                    </button>
                    <span class="obs-filmstrip__label">{{ det.formatted_time }} ¬∑ {{ "%.0f"|format(det.score * 100)
                        }}%</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</section>

{# Pagination #}
{% if total_pages > 1 %}
<nav class="pagination-wrapper" aria-label="Gallery pagination">
    <ul class="pagination">
        {% if page > 1 %}
        <li><a href="/gallery/{{ date }}?page={{ page - 1 }}&sort={{ sort_by }}&min_score={{ current_threshold }}">¬´</a>
        </li>
        {% endif %}

        {% for p in pagination_range %}
        {% if p == '...' %}
        <li class="disabled"><span>‚Ä¶</span></li>
        {% elif p == page %}
        <li class="active"><span>{{ p }}</span></li>
        {% else %}
        <li><a href="/gallery/{{ date }}?page={{ p }}&sort={{ sort_by }}&min_score={{ current_threshold }}">{{ p }}</a>
        </li>
        {% endif %}
        {% endfor %}

        {% if page < total_pages %} <li><a
                href="/gallery/{{ date }}?page={{ page + 1 }}&sort={{ sort_by }}&min_score={{ current_threshold }}">¬ª</a>
            </li>
            {% endif %}
    </ul>
</nav>
{% endif %}

{% include 'partials/inline_edit.html' %}
{% endblock %}

{% block modals %}
{% from "components/detection_modal.html" import render_modal %}

{# Species Modals #}
{% for det in species_of_day %}
{{ render_modal(det, 'species') }}
{% endfor %}

{# Observation Modals ‚Äî each observation renders modals for all its detections #}
{% for obs in observations %}
{% for det in obs.all_detections %}
{{ render_modal(det, 'obs' ~ obs.observation_id) }}
{% endfor %}
{% endfor %}
{% endblock %}

{% block scripts %}
<script src="/assets/js/gallery_utils.js?v=test_v3"></script>
<script>
    /** Toggle the filmstrip for an observation card. */
    function toggleObsFilmstrip(card) {
        const obsId = card.getAttribute('data-obs-id');
        if (!obsId) return;

        const filmstrip = document.getElementById('filmstrip-' + obsId);
        if (!filmstrip) return;

        const isOpen = filmstrip.style.display !== 'none';

        // Close all other filmstrips first
        document.querySelectorAll('.obs-filmstrip').forEach(fs => {
            fs.style.display = 'none';
        });
        document.querySelectorAll('.obs-card').forEach(c => {
            c.classList.remove('obs-card--expanded');
        });

        if (!isOpen) {
            filmstrip.style.display = 'block';
            card.classList.add('obs-card--expanded');
            // Smooth scroll to the filmstrip
            setTimeout(() => {
                filmstrip.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 50);
        }
    }

    /** Close a specific filmstrip. */
    function closeFilmstrip(obsId) {
        const filmstrip = document.getElementById('filmstrip-' + obsId);
        const card = document.getElementById('observation-' + obsId);
        if (filmstrip) filmstrip.style.display = 'none';
        if (card) card.classList.remove('obs-card--expanded');
    }

    // Scroll to observation if navigated via anchor hash
    document.addEventListener('DOMContentLoaded', function () {
        if (window.location.hash) {
            const targetId = window.location.hash.substring(1);
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
                setTimeout(() => {
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    targetEl.style.outline = '3px solid var(--color-primary)';
                    targetEl.style.outlineOffset = '2px';
                    setTimeout(() => {
                        targetEl.style.outline = '';
                        targetEl.style.outlineOffset = '';
                    }, 2000);
                }, 100);
            }
        }
    });
</script>
{% endblock %}