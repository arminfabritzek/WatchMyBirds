{% extends 'base.html' %}

{% block title %}Settings - WatchMyBirds{% endblock %}

{% block content %}
<!-- Macros for Settings Rows -->
{% macro render_setting_row(key, meta) %}
<tr>
    <td>
        <label for="{{ key }}" class="form-label mb-0 fw-semibold">{{ labels.get(key, key) }}</label>
        {% if key in advanced_keys %}<br><small class="text-muted text-monospace" style="font-size: 0.75rem">{{ key
            }}</small>{% endif %}
    </td>
    <td>
        {% if key in bool_keys %}
        <select name="{{ key }}" id="{{ key }}" class="form-select">
            <option value="true" {% if meta.value %}selected{% endif %}>true</option>
            <option value="false" {% if not meta.value %}selected{% endif %}>false</option>
        </select>
        {% elif key in number_keys %}
        {# Define defaults #}
        {% set step = 1 %}
        {% set min_val = 0 %}
        {% set max_val = "" %}

        {# Specific overrides based on key #}
        {% if key in ['CONFIDENCE_THRESHOLD_DETECTION', 'SAVE_THRESHOLD', 'CLASSIFIER_CONFIDENCE_THRESHOLD',
        'GALLERY_DISPLAY_THRESHOLD'] %}
        {% set step = 0.05 %}
        {% set min_val = 0.0 %}
        {% set max_val = 1.0 %}
        {% elif key == 'DETECTION_INTERVAL_SECONDS' %}
        {% set step = 1 %}
        {% set min_val = 0 %}
        {% set max_val = 600 %}
        {% elif key == 'TELEGRAM_COOLDOWN' %}
        {% set step = 1 %}
        {% set min_val = 0 %}
        {% set max_val = 3600 %}
        {% elif key in ['STREAM_FPS', 'STREAM_FPS_CAPTURE'] %}
        {% set step = 1 %}
        {% set min_val = 1 %}
        {% set max_val = 30 %}
        {% endif %}

        {# Format value: force integer for integer fields to avoid '5,0' #}
        {% set display_value = meta.value %}
        {% if step == 1 or step == 10 %}
        {% set display_value = meta.value | int %}
        {% endif %}

        <input type="text" name="{{ key }}" id="{{ key }}" class="form-control" value="{{ display_value }}">
        {% else %}
        <input type="text" name="{{ key }}" id="{{ key }}" class="form-control" value="{{ meta.value }}">
        {% endif %}
    </td>
    <td><span class="text-muted small">{{ meta.default }}</span></td>
    <td><span class="badge bg-light text-dark border">{{ meta.source }}</span></td>
    <td>{{ "Yes" if meta.restart_required else "No" }}</td>
</tr>
{% endmacro %}

<div class="container mt-4 mb-5">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Settings</h2>
        <a href="/" class="btn btn-outline-secondary">Back to Stream</a>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show"
        role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Main Settings Form -->
    <form method="POST" action="{{ url_for('update_settings_route') }}">

        <!-- Runtime Settings -->
        <h4 class="mt-4 mb-3">Runtime Settings</h4>
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Key</th>
                        <th>Value</th>
                        <th>Default</th>
                        <th>Source</th>
                        <th>Restart</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key in runtime_keys %}
                    {% if key in payload and key not in advanced_keys %}
                    {{ render_setting_row(key, payload[key]) }}
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Advanced Settings (Accordion) -->
        <div class="accordion my-4" id="accordionAdvanced">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingAdvanced">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseAdvanced" aria-expanded="false" aria-controls="collapseAdvanced">
                        Advanced Settings (Developer only)
                    </button>
                </h2>
                <div id="collapseAdvanced" class="accordion-collapse collapse" aria-labelledby="headingAdvanced"
                    data-bs-parent="#accordionAdvanced">
                    <div class="accordion-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-bordered mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Key</th>
                                        <th>Value</th>
                                        <th>Default</th>
                                        <th>Source</th>
                                        <th>Restart</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for key in runtime_keys %}
                                    {% if key in payload and key in advanced_keys %}
                                    {{ render_setting_row(key, payload[key]) }}
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg">Apply Changes</button>
    </form>

    <hr class="my-5">

    <!-- Tools Section -->
    <h4 class="mb-3">Tools</h4>

    <!-- Ingest UI -->
    <div class="card mb-4">
        <div class="card-header bg-light fw-bold">Image Ingest</div>
        <div class="card-body">
            <p class="card-text">Import images from the mounted <code>/ingest</code> folder. This will pause the live
                stream momentarily.</p>
            <form method="POST" action="{{ url_for('ingest_route') }}">
                <button type="submit" class="btn btn-info text-white">Start Ingest from /ingest</button>
            </form>
        </div>
    </div>

    <!-- Trash UI Link -->
    <div class="card mb-4">
        <div class="card-header bg-light fw-bold">Trash</div>
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <p class="mb-0">Manage rejected detections.</p>
                    <small class="text-muted">Contains {{ trash_count }} items.</small>
                </div>
                <a href="/trash" class="btn btn-secondary">View Trash</a>
            </div>
        </div>
    </div>

    <!-- Analytics Link -->
    <div class="card mb-4">
        <div class="card-header bg-light fw-bold">Analytics</div>
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <p class="mb-0">View all-time detection statistics and trends.</p>
                    <small class="text-muted">Species counts, score distributions, and more.</small>
                </div>
                <a href="/analytics" class="btn btn-success">View Analytics</a>
            </div>
        </div>
    </div>

    <!-- Orphan Images (Maintenance) -->
    <div class="card mb-4">
        <div class="card-header bg-light fw-bold">Orphan Images</div>
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <p class="mb-0">Manage images with no active detections.</p>
                    <small class="text-muted">Review and delete orphan files to free up disk space.</small>
                </div>
                <a href="/admin/orphans" class="btn btn-warning">Orphan Images</a>
            </div>
        </div>
    </div>

    <!-- System Settings (Read-Only) -->
    <h4 class="mt-5 mb-3">System Settings (Read-only)</h4>
    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Key</th>
                    <th>Value</th>
                    <th>Default</th>
                    <th>Source</th>
                    <th>Restart</th>
                </tr>
            </thead>
            <tbody>
                {% for key in system_keys %}
                {% if key in payload %}
                <tr>
                    <td>{{ labels.get(key, key) }}</td>
                    <td><code>{{ payload[key].value }}</code></td>
                    <td><span class="text-muted">{{ payload[key].default }}</span></td>
                    <td><span class="badge bg-secondary">{{ payload[key].source }}</span></td>
                    <td>{{ "Yes" if payload[key].restart_required else "No" }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

{% endblock %}