{% extends 'base.html' %}

{% block title %}Settings - WatchMyBirds{% endblock %}

{% block modals %}
<!-- ONVIF Credentials Modal (UI_STANDARD.md: wm-modal--form) -->
<div class="modal fade wm-modal wm-modal--form" id="onvifModal" tabindex="-1" data-bs-backdrop="static"
    aria-hidden="true">

    <div class="modal-dialog modal-lg modal-dialog-centered wm-modal__dialog">
        <div class="modal-content wm-modal__content">

            <div class="modal-header wm-modal__header">
                <div class="wm-modal__title">
                    <span class="wm-modal__title-text">ONVIF Camera Credentials</span>
                    <span class="wm-modal__title-sub" id="modalCamInfo"></span>
                </div>
                <button type="button" class="btn-close wm-modal__close" data-bs-dismiss="modal"></button>
            </div>

            <div class="wm-modal__body">
                <div class="wm-modal__fields">
                    <input type="hidden" id="modalCamIp">
                    <input type="hidden" id="modalCamPort">

                    <div class="mb-3">
                        <label for="onvifUser" class="form-label">Username</label>
                        <input type="text" class="form-control" id="onvifUser" placeholder="admin">
                    </div>
                    <div class="mb-3">
                        <label for="onvifPass" class="form-label">Password</label>
                        <input type="password" class="form-control" id="onvifPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="alert alert-danger py-2 mb-0 d-none" id="onvifModalError">
                        <small>Failed to retrieve stream. Check credentials.</small>
                    </div>
                </div>
            </div>

            <div class="wm-modal__action wm-modal__action--form">
                <div class="wm-modal__actions">
                    <button type="button" class="btn btn--secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn--primary" onclick="confirmOnvifCredentials()">
                        <span id="onvifModalSpinner" class="spinner-border spinner-border-sm d-none"></span>
                        Connect & Get Stream
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Add Camera Modal (UI_STANDARD.md: wm-modal--form) -->
<div class="modal fade wm-modal wm-modal--form" id="addCameraModal" tabindex="-1" data-bs-backdrop="static"
    data-bs-keyboard="false" aria-hidden="true">

    <div class="modal-dialog modal-lg modal-dialog-centered wm-modal__dialog">
        <div class="modal-content wm-modal__content">

            <div class="modal-header wm-modal__header">
                <div class="wm-modal__title">
                    <span class="wm-modal__title-text">Add Camera</span>
                    <span class="wm-modal__title-sub">Add a new IP camera to your saved cameras</span>
                </div>
                <button type="button" class="btn-close wm-modal__close" data-bs-dismiss="modal"></button>
            </div>

            <div class="wm-modal__body">
                <div class="wm-modal__fields">
                    <div class="mb-3">
                        <label for="addCamName" class="form-label">Camera Name</label>
                        <input type="text" class="form-control" id="addCamName" placeholder="e.g., Garden Camera">
                    </div>
                    <div class="row mb-3">
                        <div class="col-8">
                            <label for="addCamIp" class="form-label">IP Address <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addCamIp" placeholder="192.168.1.100" required>
                        </div>
                        <div class="col-4">
                            <label for="addCamPort" class="form-label">ONVIF Port</label>
                            <input type="number" class="form-control" id="addCamPort" value="80">
                            <small class="text-muted">ONVIF control port (often 80/8080), not RTSP stream port.</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="addCamUser" class="form-label">Username</label>
                        <input type="text" class="form-control" id="addCamUser" placeholder="admin">
                    </div>
                    <div class="mb-3">
                        <label for="addCamPass" class="form-label">Password</label>
                        <input type="password" class="form-control" id="addCamPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="alert alert-danger py-2 mb-0 d-none" id="addCameraError"></div>
                    <div class="alert alert-success py-2 mb-0 d-none" id="addCameraSuccess"></div>
                </div>
            </div>

            <div class="wm-modal__action wm-modal__action--form">
                <div class="wm-modal__actions">
                    <button type="button" class="btn btn--secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn--primary" onclick="saveNewCamera()">
                        <span id="addCameraSpinner" class="spinner-border spinner-border-sm d-none"></span>
                        Save Camera
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Edit Camera Modal (UI_STANDARD.md: wm-modal--form) -->
<div class="modal fade wm-modal wm-modal--form" id="editCameraModal" tabindex="-1" aria-hidden="true">

    <div class="modal-dialog modal-lg modal-dialog-centered wm-modal__dialog">
        <div class="modal-content wm-modal__content">

            <div class="modal-header wm-modal__header">
                <div class="wm-modal__title">
                    <span class="wm-modal__title-text">Edit Camera</span>
                    <span class="wm-modal__title-sub">Update camera settings</span>
                </div>
                <button type="button" class="btn-close wm-modal__close" data-bs-dismiss="modal"></button>
            </div>

            <div class="wm-modal__body">
                <div class="wm-modal__fields">
                    <input type="hidden" id="editCamId">
                    <div class="mb-3">
                        <label for="editCamName" class="form-label">Camera Name</label>
                        <input type="text" class="form-control" id="editCamName">
                    </div>
                    <div class="row mb-3">
                        <div class="col-8">
                            <label for="editCamIp" class="form-label">IP Address</label>
                            <input type="text" class="form-control" id="editCamIp">
                        </div>
                        <div class="col-4">
                            <label for="editCamPort" class="form-label">ONVIF Port</label>
                            <input type="number" class="form-control" id="editCamPort">
                            <small class="text-muted">ONVIF control port (often 80/8080), not RTSP stream port.</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editCamUser" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editCamUser">
                    </div>
                    <div class="mb-3">
                        <label for="editCamPass" class="form-label">Password <small class="text-muted">(leave blank to
                                keep)</small></label>
                        <input type="password" class="form-control" id="editCamPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="alert alert-danger py-2 mb-0 d-none" id="editCameraError"></div>
                </div>
            </div>

            <div class="wm-modal__action wm-modal__action--form">
                <div class="wm-modal__actions">
                    <button type="button" class="btn btn--secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn--primary" onclick="updateCamera()">
                        <span id="editCameraSpinner" class="spinner-border spinner-border-sm d-none"></span>
                        Update Camera
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- ONVIF Discovery Logic ---
    function startOnvifDiscovery() {
        const resultsDiv = document.getElementById('onvifResults');
        const listGroup = document.getElementById('onvifCameraList');
        const loading = document.getElementById('onvifLoading');
        const btn = document.getElementById('btnScanOnvif');

        resultsDiv.classList.remove('d-none');
        listGroup.innerHTML = '';
        loading.classList.remove('d-none');
        btn.disabled = true;

        fetch('/api/v1/onvif/discover')
            .then(res => res.json())
            .then(data => {
                loading.classList.add('d-none');
                btn.disabled = false;

                if (data.status === 'success' && data.cameras.length > 0) {
                    data.cameras.forEach(cam => {
                        const item = document.createElement('button');
                        item.type = "button";
                        item.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
                        item.style.fontSize = "0.85rem";
                        item.innerHTML = `
                                <div>
                                    <div class="fw-bold">${cam.name || 'Generic ONVIF'}</div>
                                    <div class="text-muted small">${cam.ip}:${cam.port}</div>
                                </div>
                                <span class="badge bg-primary rounded-pill">Select</span>
                            `;
                        item.onclick = () => showOnvifConfigModal(cam);
                        listGroup.appendChild(item);
                    });
                } else {
                    listGroup.innerHTML = '<div class="p-3 text-center text-muted small">No ONVIF cameras found on your network.</div>';
                }
            })
            .catch(err => {
                loading.classList.add('d-none');
                btn.disabled = false;
                listGroup.innerHTML = '<div class="p-3 text-center text-danger small">Discovery failed. Check network connection.</div>';
                console.error("Discovery error:", err);
            });
    }

    function showOnvifConfigModal(cam) {
        document.getElementById('modalCamInfo').innerText = `Configuring: ${cam.name || 'Unknown Camera'} (${cam.ip}:${cam.port})`;
        document.getElementById('modalCamIp').value = cam.ip;
        document.getElementById('modalCamPort').value = cam.port;

        // Clear previous errors
        document.getElementById('onvifModalError').classList.add('d-none');

        const modal = new bootstrap.Modal(document.getElementById('onvifModal'));
        modal.show();
    }

    function confirmOnvifCredentials() {
        const ip = document.getElementById('modalCamIp').value;
        const port = document.getElementById('modalCamPort').value;
        const username = document.getElementById('onvifUser').value;
        const password = document.getElementById('onvifPass').value;
        const spinner = document.getElementById('onvifModalSpinner');
        const errorDiv = document.getElementById('onvifModalError');

        spinner.classList.remove('d-none');
        errorDiv.classList.add('d-none');

        fetch('/api/v1/onvif/get_stream_uri', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ip, port, username, password })
        })
            .then(res => res.json())
            .then(data => {
                spinner.classList.add('d-none');
                if (data.status === 'success') {
                    // Success! Fill the RTSP URL
                    document.getElementById('cameraUrlInput').value = data.uri;
                    updateCameraUrl(data.uri);

                    // Close modal
                    const modalEl = document.getElementById('onvifModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();

                    // Hide results
                    document.getElementById('onvifResults').classList.add('d-none');
                } else {
                    errorDiv.classList.remove('d-none');
                    errorDiv.innerText = data.message || "Failed to get stream URI.";
                }
            })
            .catch(err => {
                spinner.classList.add('d-none');
                errorDiv.classList.remove('d-none');
                errorDiv.innerText = "Connection error. Ensure camera is reachable.";
                console.error("Stream URI error:", err);
            });
    }

    function toggleUrlVisibility() {
        const input = document.getElementById('cameraUrlInput');
        const btn = document.getElementById('btnToggleUrl');
        if (input.type === 'password') {
            input.type = 'text';
            btn.innerHTML = 'üîí';
        } else {
            input.type = 'password';
            btn.innerHTML = 'üëÅ';
        }
    }

    // --- Camera Management Logic ---
    function loadSavedCameras() {
        const container = document.getElementById('savedCamerasList');
        if (!container) return;

        container.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></div>';

        fetch('/api/v1/cameras')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success' && data.cameras.length > 0) {
                    container.innerHTML = '';
                    data.cameras.forEach(cam => {
                        const statusBadge = cam.last_test_success === true
                            ? '<span class="badge bg-success">‚úì Connected</span>'
                            : cam.last_test_success === false
                                ? '<span class="badge bg-danger">‚úó Failed</span>'
                                : '<span class="badge bg-secondary">Not Tested</span>';

                        const item = document.createElement('div');
                        item.className = 'list-group-item d-flex justify-content-between align-items-center';
                        item.innerHTML = `
                            <div>
                                <div class="fw-bold">${cam.name || 'Camera ' + (cam.id + 1)}</div>
                                <div class="text-muted small">${cam.ip}:${cam.port}</div>
                                ${cam.manufacturer ? `<div class="text-muted small">${cam.manufacturer} ${cam.model || ''}</div>` : ''}
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                ${statusBadge}
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary" onclick="testCamera(${cam.id})" title="Test Connection">
                                        <span id="testSpinner${cam.id}" class="spinner-border spinner-border-sm d-none"></span>
                                        üîå Test
                                    </button>
                                    <button type="button" class="btn btn-outline-success" onclick="useCamera(${cam.id})" title="Activate this camera as video source">üìπ Use</button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="editCamera(${cam.id})" title="Edit camera settings">‚úèÔ∏è</button>
                                    <button type="button" class="btn btn-outline-danger" onclick="deleteCamera(${cam.id})" title="Delete camera">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = '<div class="text-center text-muted p-3">No cameras saved. Use "Scan Network" or "Add Camera" to add one.</div>';
                }
            })
            .catch(err => {
                container.innerHTML = '<div class="text-center text-danger p-3">Failed to load cameras.</div>';
                console.error('Load cameras error:', err);
            });
    }

    function showAddCameraModal() {
        // Reset form
        document.getElementById('addCamName').value = '';
        document.getElementById('addCamIp').value = '';
        document.getElementById('addCamPort').value = '80';
        document.getElementById('addCamUser').value = '';
        document.getElementById('addCamPass').value = '';
        document.getElementById('addCameraError').classList.add('d-none');
        document.getElementById('addCameraSuccess').classList.add('d-none');

        const modal = new bootstrap.Modal(document.getElementById('addCameraModal'));
        modal.show();
    }

    function saveNewCamera() {
        const spinner = document.getElementById('addCameraSpinner');
        const errorDiv = document.getElementById('addCameraError');
        const successDiv = document.getElementById('addCameraSuccess');

        const payload = {
            name: document.getElementById('addCamName').value,
            ip: document.getElementById('addCamIp').value,
            port: parseInt(document.getElementById('addCamPort').value) || 80,
            username: document.getElementById('addCamUser').value,
            password: document.getElementById('addCamPass').value
        };

        if (!payload.ip) {
            errorDiv.innerText = 'IP address is required.';
            errorDiv.classList.remove('d-none');
            return;
        }

        spinner.classList.remove('d-none');
        errorDiv.classList.add('d-none');

        fetch('/api/v1/cameras', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(res => res.json())
            .then(data => {
                spinner.classList.add('d-none');
                if (data.status === 'success') {
                    successDiv.innerText = 'Camera saved successfully!';
                    successDiv.classList.remove('d-none');
                    loadSavedCameras();
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addCameraModal'));
                        modal.hide();
                    }, 1000);
                } else {
                    errorDiv.innerText = data.message || 'Failed to save camera.';
                    errorDiv.classList.remove('d-none');
                }
            })
            .catch(err => {
                spinner.classList.add('d-none');
                errorDiv.innerText = 'Connection error.';
                errorDiv.classList.remove('d-none');
                console.error('Save camera error:', err);
            });
    }

    function testCamera(camId) {
        const spinner = document.getElementById('testSpinner' + camId);
        if (spinner) spinner.classList.remove('d-none');

        fetch(`/api/v1/cameras/${camId}/test`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (spinner) spinner.classList.add('d-none');
                if (data.status === 'success') {
                    alert(`‚úÖ Connection successful!\n\nManufacturer: ${data.details.manufacturer || 'N/A'}\nModel: ${data.details.model || 'N/A'}\nPTZ Support: ${data.details.has_ptz ? 'Yes' : 'No'}`);
                } else {
                    alert(`‚ùå Connection failed: ${data.message}`);
                }
                loadSavedCameras(); // Refresh to show status badge
            })
            .catch(err => {
                if (spinner) spinner.classList.add('d-none');
                alert('Connection test failed. Network error.');
                console.error('Test camera error:', err);
            });
    }

    function editCamera(camId) {
        fetch('/api/v1/cameras')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const cam = data.cameras.find(c => c.id === camId);
                    if (cam) {
                        document.getElementById('editCamId').value = cam.id;
                        document.getElementById('editCamName').value = cam.name || '';
                        document.getElementById('editCamIp').value = cam.ip || '';
                        document.getElementById('editCamPort').value = cam.port || 80;
                        document.getElementById('editCamUser').value = cam.username || '';
                        document.getElementById('editCamPass').value = '';
                        document.getElementById('editCameraError').classList.add('d-none');

                        const modal = new bootstrap.Modal(document.getElementById('editCameraModal'));
                        modal.show();
                    }
                }
            });
    }

    function updateCamera() {
        const camId = document.getElementById('editCamId').value;
        const spinner = document.getElementById('editCameraSpinner');
        const errorDiv = document.getElementById('editCameraError');

        const payload = {
            name: document.getElementById('editCamName').value,
            ip: document.getElementById('editCamIp').value,
            port: parseInt(document.getElementById('editCamPort').value) || 80,
            username: document.getElementById('editCamUser').value
        };

        // Only include password if provided
        const pass = document.getElementById('editCamPass').value;
        if (pass) payload.password = pass;

        spinner.classList.remove('d-none');

        fetch(`/api/v1/cameras/${camId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(res => res.json())
            .then(data => {
                spinner.classList.add('d-none');
                if (data.status === 'success') {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editCameraModal'));
                    modal.hide();
                    loadSavedCameras();
                } else {
                    errorDiv.innerText = data.message || 'Failed to update camera.';
                    errorDiv.classList.remove('d-none');
                }
            })
            .catch(err => {
                spinner.classList.add('d-none');
                errorDiv.innerText = 'Connection error.';
                errorDiv.classList.remove('d-none');
            });
    }

    function deleteCamera(camId) {
        if (!confirm('Are you sure you want to delete this camera?')) return;

        fetch(`/api/v1/cameras/${camId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    loadSavedCameras();
                } else {
                    alert('Failed to delete camera: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(err => {
                alert('Connection error while deleting camera.');
                console.error('Delete camera error:', err);
            });
    }

    function useCamera(camId) {
        // Call backend to use camera with stored credentials
        const btn = (typeof event !== 'undefined' && event && event.target)
            ? event.target.closest('button')
            : null;
        const originalHtml = btn ? btn.innerHTML : null;
        if (btn) {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.disabled = true;
        }

        fetch(`/api/v1/cameras/${camId}/use`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (btn) {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }

                if (data.status === 'success') {
                    // Show success feedback
                    alert(`‚úÖ ${data.message}\n\nVideo source has been updated. The stream will switch shortly.`);
                    // Reload page to reflect new VIDEO_SOURCE
                    window.location.reload();
                } else {
                    alert(`‚ùå Failed to activate camera: ${data.message}`);
                }
            })
            .catch(err => {
                if (btn) {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
                alert('Connection error while activating camera.');
                console.error('Use camera error:', err);
            });
    }

    // Discovery for Camera Management Section
    function startOnvifDiscoveryCamSection() {
        const resultsDiv = document.getElementById('camSectionDiscoveryResults');
        const listGroup = document.getElementById('camSectionDiscoveryList');
        const loading = document.getElementById('camSectionDiscoveryLoading');

        resultsDiv.classList.remove('d-none');
        listGroup.innerHTML = '';
        loading.classList.remove('d-none');

        fetch('/api/v1/onvif/discover')
            .then(res => res.json())
            .then(data => {
                loading.classList.add('d-none');

                if (data.status === 'success' && data.cameras.length > 0) {
                    data.cameras.forEach(cam => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item d-flex justify-content-between align-items-center';

                        // Escape special characters for safe inline onclick
                        const safeName = (cam.name || 'ONVIF Camera').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const safeManufacturer = (cam.manufacturer || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

                        item.innerHTML = `
                            <div>
                                <div class="fw-bold">${cam.name || 'ONVIF Camera'}</div>
                                <div class="text-muted small">${cam.ip}:${cam.port}</div>
                                ${cam.manufacturer ? `<div class="text-muted small">${cam.manufacturer}</div>` : ''}
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" onclick="addDiscoveredCamera('${cam.ip}', ${cam.port}, '${safeName}', '${safeManufacturer}')">
                                ‚ûï Add
                            </button>
                        `;
                        listGroup.appendChild(item);
                    });
                } else {
                    listGroup.innerHTML = '<div class="text-center text-muted p-3">No ONVIF cameras found on the network.</div>';
                }
            })
            .catch(err => {
                loading.classList.add('d-none');
                listGroup.innerHTML = '<div class="text-center text-danger p-3">Discovery failed. Check network connection.</div>';
                console.error('Discovery error:', err);
            });
    }

    function addDiscoveredCamera(ip, port, name, manufacturer) {
        // Pre-fill the Add Camera modal with discovered camera info
        document.getElementById('addCamName').value = name || 'Camera';
        document.getElementById('addCamIp').value = ip;
        document.getElementById('addCamPort').value = port || 80;
        document.getElementById('addCamUser').value = '';
        document.getElementById('addCamPass').value = '';
        document.getElementById('addCameraError').classList.add('d-none');
        document.getElementById('addCameraSuccess').classList.add('d-none');

        const modal = new bootstrap.Modal(document.getElementById('addCameraModal'));
        modal.show();
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadSavedCameras();
    });

    // Set camera URL via API
    function setCameraUrl(value) {
        if (!value || value.trim() === '') {
            alert('Please enter a valid camera URL');
            return;
        }

        const trimmed = value.trim();

        // Show loading feedback
        const btn = (typeof event !== 'undefined' && event && event.target)
            ? event.target
            : null;
        const originalText = btn ? btn.textContent : null;
        if (btn) {
            btn.textContent = '...';
            btn.disabled = true;
        }

        // Update via settings API
        const modeSelect = document.getElementById('STREAM_SOURCE_MODE');
        const payload = { CAMERA_URL: trimmed };
        if (modeSelect) payload.STREAM_SOURCE_MODE = modeSelect.value;
        fetch('/api/v1/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(err => { throw new Error(err.message || err.errors || 'API Error'); });
                }
                return res.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert(`‚úÖ Camera URL updated!\n\nNew source: ${trimmed}\n\nPage will reload.`);
                    window.location.reload();
                } else {
                    alert(`‚ùå Failed: ${data.message || 'Unexpected response'}`);
                    if (btn) {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }
                }
            })
            .catch(err => {
                alert(`‚ùå Error: ${err.message || 'Connection failed'}`);
                console.error(err);
                if (btn) {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });
    }
</script>
{% endblock %}

{% block content %}
<!-- Macros for Settings Rows -->
{% macro render_setting_row(key, meta) %}
<tr>
    <td>
        <label for="{{ key }}" class="form-label mb-0 fw-semibold">{{ labels.get(key, key) }}</label>
        {% if key in advanced_keys %}<br><small class="text-muted text-monospace" style="font-size: 0.75rem">{{ key
            }}</small>{% endif %}
    </td>
    <td>
        {% if key in bool_keys %}
        <select name="{{ key }}" id="{{ key }}" class="form-select">
            <option value="true" {% if meta.value %}selected{% endif %}>true</option>
            <option value="false" {% if not meta.value %}selected{% endif %}>false</option>
        </select>‚Äö
        {% elif key in number_keys %}
        {# Define defaults #}
        {% set step = 1 %}
        {% set min_val = 0 %}
        {% set max_val = "" %}

        {# Specific overrides based on key #}
        {% if key in ['CONFIDENCE_THRESHOLD_DETECTION', 'SAVE_THRESHOLD', 'CLASSIFIER_CONFIDENCE_THRESHOLD',
        'GALLERY_DISPLAY_THRESHOLD'] %}
        {% set step = 0.05 %}
        {% set min_val = 0.0 %}
        {% set max_val = 1.0 %}
        {% elif key == 'DETECTION_INTERVAL_SECONDS' %}
        {% set step = 1 %}
        {% set min_val = 0 %}
        {% set max_val = 600 %}
        {% elif key == 'TELEGRAM_COOLDOWN' %}
        {% set step = 1 %}
        {% set min_val = 0 %}
        {% set max_val = 3600 %}
        {% elif key in ['STREAM_FPS', 'STREAM_FPS_CAPTURE'] %}
        {% set step = 1 %}
        {% set min_val = 1 %}
        {% set max_val = 15 %}
        {% endif %}

        {# Format value: force integer for integer fields to avoid '5,0' #}
        {% set display_value = meta.value %}
        {% if step == 1 or step == 10 %}
        {% set display_value = meta.value | int %}
        {% endif %}

        <input type="text" name="{{ key }}" id="{{ key }}" class="form-control" value="{{ display_value }}">
        {% elif key == 'LOCATION_DATA' %}
        {# Format dict to string for display #}
        {% set loc_val = meta.value %}
        {% if loc_val is mapping and 'latitude' in loc_val %}
        {% set loc_str = loc_val.latitude ~ ', ' ~ loc_val.longitude %}
        <input type="text" name="{{ key }}" id="{{ key }}" class="form-control" value="{{ loc_str }}"
            placeholder="lat, lon">
        {% else %}
        <input type="text" name="{{ key }}" id="{{ key }}" class="form-control" value="{{ meta.value }}">
        {% endif %}
        {% else %}
        <input type="text" name="{{ key }}" id="{{ key }}" class="form-control" value="{{ meta.value }}">
        {% endif %}
    </td>
    <td><span class="text-muted small">{{ meta.default }}</span></td>
    <td><span class="badge bg-light text-dark border">{{ meta.source }}</span></td>
    <td>{{ "Yes" if meta.restart_required else "No" }}</td>
</tr>
{% endmacro %}

<div class="container mt-4 mb-5">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Settings</h2>
        <a href="/" class="btn btn-outline-secondary">Back to Stream</a>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show"
        role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Main Settings Form -->
    <form id="settingsForm" onsubmit="return submitSettingsForm(event)">

        <!-- 1. Stream & Performance -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white fw-bold">1. Stream & Performance</div>
            <div class="card-body">

                <!-- Camera source -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Camera Source</label>

                    <!-- Runtime source (live) -->
                    <div class="alert alert-info py-2 mb-2">
                        <strong>Runtime Source (live):</strong>
                        <code id="runtimeSourceDisplay">{{ payload.get('STREAM_SOURCE_RUNTIME_VIDEO', {}).get('value', payload['VIDEO_SOURCE'].value) }}</code>
                        <span
                            class="badge ms-2 {{ 'text-bg-success' if payload.get('STREAM_SOURCE_RUNTIME_MODE', {}).get('value', 'direct') == 'relay' else 'text-bg-primary' }}"
                            id="runtimeModeBadge">
                            runtime: {{ payload.get('STREAM_SOURCE_RUNTIME_MODE', {}).get('value', 'direct') | default('direct') }}
                        </span>
                    </div>

                    <!-- Resolver decision -->
                    <div class="alert alert-light border py-2 mb-3">
                        <strong>Resolver Decision:</strong>
                        <span class="badge text-bg-secondary ms-2" id="resolverModeBadge">
                            resolver: {{ payload.get('STREAM_SOURCE_EFFECTIVE_MODE', {}).get('value', 'direct') | default('direct') }}
                        </span>
                        <span class="badge text-bg-light border text-dark ms-1" id="streamModeSettingBadge">
                            setting: {{ payload.get('STREAM_SOURCE_MODE', {}).get('value', 'auto') | default('auto') }}
                        </span>
                        <div class="form-text text-muted small mt-1" id="streamModeReason">
                            {{ payload.get('STREAM_SOURCE_REASON', {}).get('value', '') }}
                        </div>
                    </div>

                    <!-- User-facing source field -->
                    <input type="hidden" name="CAMERA_URL" id="CAMERA_URL"
                        value="{{ payload.get('CAMERA_URL', {}).get('value', '') }}">

                    <!-- Simple Input Options -->
                    <div class="row g-2">
                        <!-- USB Camera Quick Select -->
                        <div class="col-md-3">
                            <label class="small text-muted">USB Camera</label>
                            <div class="input-group input-group-sm">
                                <select id="usbIndexSelect" class="form-select form-select-sm">
                                    <option value="0">Camera 0</option>
                                    <option value="1">Camera 1</option>
                                    <option value="2">Camera 2</option>
                                </select>
                                <button type="button" class="btn btn-primary btn-sm"
                                    onclick="setCameraUrl(document.getElementById('usbIndexSelect').value)">Set</button>
                            </div>
                        </div>

                        <!-- Camera URL -->
                        <div class="col-md-9">
                            <label class="small text-muted">Camera URL (rtsp:// or http://)</label>
                            <div class="input-group input-group-sm">
                                <input type="text" id="cameraUrlInput" class="form-control form-control-sm"
                                    value="{{ payload.get('CAMERA_URL', {}).get('value', '') }}"
                                    placeholder="rtsp://user:pass@192.168.1.100:554/stream">
                                <button type="button" class="btn btn-primary btn-sm"
                                    onclick="setCameraUrl(document.getElementById('cameraUrlInput').value)">Apply</button>
                            </div>
                            <div class="form-text text-muted small mt-1">
                                Passwords stay masked as <code>*****</code>. Replace stars only if you want to change credentials.
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label for="STREAM_SOURCE_MODE" class="small text-muted">Stream Routing Mode</label>
                            <select name="STREAM_SOURCE_MODE" id="STREAM_SOURCE_MODE" class="form-select form-select-sm text-dark">
                                <option value="auto" {{ 'selected' if payload.get('STREAM_SOURCE_MODE', {}).get('value', 'auto') == 'auto' }}>auto (use go2rtc if available)</option>
                                <option value="relay" {{ 'selected' if payload.get('STREAM_SOURCE_MODE', {}).get('value', 'auto') == 'relay' }}>relay (always go2rtc)</option>
                                <option value="direct" {{ 'selected' if payload.get('STREAM_SOURCE_MODE', {}).get('value', 'auto') == 'direct' }}>direct (camera -> app)</option>
                            </select>
                            <div class="form-text text-muted small">
                                <strong>auto:</strong> prefer go2rtc and fallback to direct. <strong>relay:</strong> force go2rtc. <strong>direct:</strong> app connects directly.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-muted">Effective Video Source (read-only)</label>
                            <input type="text" class="form-control form-control-sm" readonly disabled
                                value="{{ payload['VIDEO_SOURCE'].value }}">
                        </div>
                    </div>

                    <div class="form-text text-muted mt-2">
                        Use the "Use" button on saved cameras below to activate them directly.
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="STREAM_FPS_CAPTURE" class="form-label fw-bold">Capture FPS (Throttling)</label>
                        <input type="number" name="STREAM_FPS_CAPTURE" id="STREAM_FPS_CAPTURE" class="form-control"
                            value="{{ payload['STREAM_FPS_CAPTURE'].value }}" min="1" max="60">
                        <div class="form-text text-success"><small><strong>Low (1-5):</strong> Saves CPU. Good for
                                monitoring.</small></div>
                        <div class="form-text text-danger"><small><strong>High (20+):</strong> High CPU usage.</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="STREAM_FPS" class="form-label fw-bold">Live View FPS</label>
                        <input type="number" name="STREAM_FPS" id="STREAM_FPS" class="form-control"
                            value="{{ payload['STREAM_FPS'].value }}" min="1" max="30">
                        <div class="form-text text-muted"><small>Browser refresh rate. Lower = Less bandwidth.</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="STREAM_WIDTH_OUTPUT_RESIZE" class="form-label fw-bold">Live View Width</label>
                        <input type="number" name="STREAM_WIDTH_OUTPUT_RESIZE" id="STREAM_WIDTH_OUTPUT_RESIZE"
                            class="form-control" value="{{ payload['STREAM_WIDTH_OUTPUT_RESIZE'].value }}">
                        <div class="form-text text-muted"><small>Resize width (e.g., 640). Leave empty for full.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera Management Section -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white fw-bold d-flex justify-content-between align-items-center">
                üì∑ Camera Management
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-light btn-sm" onclick="startOnvifDiscoveryCamSection()">
                        üîç Scan Network
                    </button>
                    <button type="button" class="btn btn-light btn-sm" onclick="showAddCameraModal()">
                        ‚ûï Add Camera
                    </button>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    Manage ONVIF cameras. Add cameras manually or scan the network to discover them automatically.
                </p>

                <!-- Saved Cameras List -->
                <h6 class="fw-bold mb-2">Saved Cameras</h6>
                <div id="savedCamerasList" class="list-group mb-3">
                    <div class="text-center text-muted p-3">Loading...</div>
                </div>

                <!-- Discovery Results (hidden by default) -->
                <div id="camSectionDiscoveryResults" class="d-none">
                    <h6 class="fw-bold mb-2">Discovered Cameras</h6>
                    <div id="camSectionDiscoveryLoading" class="text-center p-2 d-none">
                        <div class="spinner-border spinner-border-sm text-info"></div>
                        <span class="ms-1 small">Scanning network...</span>
                    </div>
                    <div id="camSectionDiscoveryList" class="list-group mb-3"></div>
                </div>
            </div>
        </div>

        <!-- 2. Detection Settings -->
        <div class="card mb-4">
            <div class="card-header bg-light fw-bold">2. Detection Logic</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="CONFIDENCE_THRESHOLD_DETECTION" class="form-label fw-bold">Detection
                            Sensitivity</label>
                        <input type="number" step="0.05" name="CONFIDENCE_THRESHOLD_DETECTION"
                            id="CONFIDENCE_THRESHOLD_DETECTION" class="form-control"
                            value="{{ payload['CONFIDENCE_THRESHOLD_DETECTION'].value }}">
                        <div class="form-text">0.1 (Sensitive) to 0.9 (Strict). Default: 0.5</div>
                    </div>
                    <div class="col-md-6">
                        <label for="SAVE_THRESHOLD" class="form-label fw-bold">Save Threshold</label>
                        <input type="number" step="0.05" name="SAVE_THRESHOLD" id="SAVE_THRESHOLD" class="form-control"
                            value="{{ payload['SAVE_THRESHOLD'].value }}">
                        <div class="form-text">Minimum score to save image to disk.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="DETECTION_INTERVAL_SECONDS" class="form-label fw-bold">Detection Interval
                            (s)</label>
                        <input type="number" name="DETECTION_INTERVAL_SECONDS" id="DETECTION_INTERVAL_SECONDS"
                            class="form-control" value="{{ payload['DETECTION_INTERVAL_SECONDS'].value }}">
                        <div class="form-text">Seconds to wait between detections.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="DAY_AND_NIGHT_CAPTURE" class="form-label fw-bold">Night Mode Capture</label>
                        <select name="DAY_AND_NIGHT_CAPTURE" id="DAY_AND_NIGHT_CAPTURE" class="form-select">
                            <option value="true" {% if payload['DAY_AND_NIGHT_CAPTURE'].value %}selected{% endif %}>
                                Enabled (Capture 24/7)</option>
                            <option value="false" {% if not payload['DAY_AND_NIGHT_CAPTURE'].value %}selected{% endif
                                %}>Disabled (Daylight Only)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Notifications -->
        <div class="card mb-4">
            <div class="card-header bg-light fw-bold">3. Notifications (Telegram)</div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="TELEGRAM_ENABLED" class="form-label fw-bold">Telegram Enabled</label>
                    <select name="TELEGRAM_ENABLED" id="TELEGRAM_ENABLED" class="form-select w-auto">
                        <option value="true" {% if payload['TELEGRAM_ENABLED'].value %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not payload['TELEGRAM_ENABLED'].value %}selected{% endif %}>No
                        </option>
                    </select>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="TELEGRAM_BOT_TOKEN" class="form-label">Bot Token</label>
                        <input type="text" name="TELEGRAM_BOT_TOKEN" id="TELEGRAM_BOT_TOKEN" class="form-control"
                            value="{{ payload['TELEGRAM_BOT_TOKEN'].value }}">
                    </div>
                    <div class="col-md-6">
                        <label for="TELEGRAM_CHAT_ID" class="form-label">Chat ID</label>
                        <input type="text" name="TELEGRAM_CHAT_ID" id="TELEGRAM_CHAT_ID" class="form-control"
                            value="{{ payload['TELEGRAM_CHAT_ID'].value }}">
                    </div>
                    <div class="col-md-12">
                        <label for="TELEGRAM_COOLDOWN" class="form-label">Cooldown (Seconds)</label>
                        <input type="number" name="TELEGRAM_COOLDOWN" id="TELEGRAM_COOLDOWN" class="form-control w-auto"
                            value="{{ payload['TELEGRAM_COOLDOWN'].value }}">
                        <div class="form-text">Minimum time between messages.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. System & Location -->
        <div class="card mb-4">
            <div class="card-header bg-light fw-bold">4. System & Location</div>
            <div class="card-body">
                <!-- Location Logic -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Location (GPS)</label>
                    <input type="hidden" name="LOCATION_DATA" id="LOCATION_DATA"
                        value="{{ payload['LOCATION_DATA'].value if payload['LOCATION_DATA'].value is string else '' }}">
                    <!-- We need to safely parse the existing dict if it comes rendered as text or check payload type -->

                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="small text-muted">Latitude</label>
                            <input type="text" id="locLat" class="form-control" placeholder="52.5200"
                                onchange="updateLocationJson()">
                        </div>
                        <div class="col-sm-6">
                            <label class="small text-muted">Longitude</label>
                            <input type="text" id="locLon" class="form-control" placeholder="13.4050"
                                onchange="updateLocationJson()">
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="EXIF_GPS_ENABLED" class="form-label">Write GPS to Metadata</label>
                        <select name="EXIF_GPS_ENABLED" id="EXIF_GPS_ENABLED" class="form-select">
                            <option value="true" {% if payload['EXIF_GPS_ENABLED'].value %}selected{% endif %}>Yes
                            </option>
                            <option value="false" {% if not payload['EXIF_GPS_ENABLED'].value %}selected{% endif %}>No
                            </option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="DEBUG_MODE" class="form-label">Debug Mode</label>
                        <select name="DEBUG_MODE" id="DEBUG_MODE" class="form-select">
                            <option value="true" {% if payload['DEBUG_MODE'].value %}selected{% endif %}>Enabled
                                (Verbose Logs)</option>
                            <option value="false" {% if not payload['DEBUG_MODE'].value %}selected{% endif %}>Disabled
                            </option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <label for="EDIT_PASSWORD" class="form-label">Settings Password (Optional)</label>
                        <input type="text" name="EDIT_PASSWORD" id="EDIT_PASSWORD" class="form-control"
                            value="{{ payload['EDIT_PASSWORD'].value }}">
                    </div>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg w-100 mb-5" id="settingsSubmitBtn">Apply & Restart Services</button>
    </form>

    <!-- JS Logic for Source and Location -->
    <script>
        // Init logic on load
        document.addEventListener('DOMContentLoaded', function () {
            initCameraUrl();
            initLocation();
            loadSystemVersions();
        });

        function loadSystemVersions() {
            fetch('/api/v1/system/versions')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('si-app').innerText = data.app_version || 'N/A';
                    document.getElementById('si-kernel').innerText = data.kernel || 'N/A';
                    document.getElementById('si-os').innerText = data.os || 'N/A';
                    document.getElementById('si-boot').innerText = data.bootloader || 'N/A';
                })
                .catch(err => {
                    console.error("Failed to load versions", err);
                });
        }

        // --- Camera URL Logic ---
        function updateCameraUrl(forceValue) {
            const hidden = document.getElementById('CAMERA_URL');
            if (!hidden) return;

            const streamInput = document.getElementById('cameraUrlInput');
            const usbSelect = document.getElementById('usbIndexSelect');

            const streamVal = streamInput ? streamInput.value.trim() : '';
            const usbVal = usbSelect ? usbSelect.value.trim() : '';

            let nextVal = '';
            if (forceValue !== undefined && forceValue !== null) {
                nextVal = String(forceValue).trim();
            } else {
                nextVal = streamVal || usbVal;
            }

            if (!nextVal) return;

            hidden.value = nextVal;
            const display = document.getElementById('runtimeSourceDisplay');
            if (display) display.textContent = nextVal;
        }

        function initCameraUrl() {
            const currentVal = document.getElementById('CAMERA_URL').value;
            // Prefill stream URL input if current source is a URL
            if (currentVal && !(/^\d+$/.test(currentVal))) {
                document.getElementById('cameraUrlInput').value = currentVal;
            }
        }

        // --- Location Logic ---
        function initLocation() {
            const rawLat = "{{ payload['LOCATION_DATA'].value.get('latitude', '') if payload['LOCATION_DATA'].value is mapping else '' }}";
            const rawLon = "{{ payload['LOCATION_DATA'].value.get('longitude', '') if payload['LOCATION_DATA'].value is mapping else '' }}";

            document.getElementById('locLat').value = rawLat;
            document.getElementById('locLon').value = rawLon;
        }

        function updateLocationJson() {
            const lat = document.getElementById('locLat').value.trim();
            const lon = document.getElementById('locLon').value.trim();

            if (!lat && !lon) {
                document.getElementById('LOCATION_DATA').value = "";
                return;
            }

            // Format as "lat, lon" expected by backend config.py
            document.getElementById('LOCATION_DATA').value = `${lat}, ${lon}`;
        }

        function submitSettingsForm(event) {
            event.preventDefault();

            // Ensure final sync of derived fields
            updateCameraUrl();
            updateLocationJson();

            const form = document.getElementById('settingsForm');
            const btn = document.getElementById('settingsSubmitBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Saving...';
            btn.disabled = true;

            // Collect all named form fields into a JSON payload
            const formData = new FormData(form);
            const payload = {};
            for (const [key, value] of formData.entries()) {
                payload[key] = value;
            }

            fetch('/api/v1/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(err => {
                        throw new Error(err.message || JSON.stringify(err.errors) || 'API Error');
                    });
                }
                return res.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('‚úÖ Settings saved successfully! Page will reload.');
                    window.location.reload();
                } else {
                    alert('‚ùå Failed: ' + (data.message || 'Unexpected response'));
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            })
            .catch(err => {
                alert('‚ùå Error: ' + (err.message || 'Connection failed'));
                console.error(err);
                btn.textContent = originalText;
                btn.disabled = false;
            });

            return false;
        }
    </script>

    <hr class="my-5">

    <!-- Tools Section -->
    <h4 class="mb-3">Tools</h4>

    <!-- Advanced Section (collapsed by default) -->
    <details class="mb-4">
        <summary class="card-header bg-secondary text-white fw-bold"
            style="cursor: pointer; list-style: none; padding: 0.75rem 1rem; border-radius: 0.25rem;">
            ‚öôÔ∏è Advanced
        </summary>

        <!-- Ingest UI (legacy - for Docker mounts) -->
        <div class="card mt-2">
            <div class="card-header bg-light fw-bold">Image Ingest (Legacy)</div>
            <div class="card-body">
                <p class="card-text text-muted">
                    <small>For Docker deployments: Import images from the mounted <code>/ingest</code>
                        folder.</small>
                </p>
                <p class="card-text text-muted">
                    <small>üí° For normal uploads, use the <a href="/inbox">Inbox</a>.</small>
                </p>
                <form method="POST" action="{{ url_for('ingest_route') }}">
                    <button type="submit" class="btn btn-secondary btn-sm">Start Ingest from /ingest</button>
                </form>
            </div>
        </div>
    </details>

    <!-- Backup & Migration -->
    <div class="card mb-4">
        <div class="card-header bg-light fw-bold">üíæ Backup & Migration</div>
        <div class="card-body">
            <p class="card-text">Create a full backup of your database, images, and settings.
                Detection is automatically paused during backup.</p>
            <div class="d-flex gap-2 flex-wrap">
                <a href="/backup" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="margin-right: 6px; vertical-align: -2px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    Create Backup
                </a>
                <a href="/restore" class="btn btn-outline-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="margin-right: 6px; vertical-align: -2px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    Import Backup
                </a>
            </div>
        </div>
    </div>







    <script>
        function confirmShutdown() {
            if (confirm("Are you sure you want to SHUT DOWN the Raspberry Pi? The system will be unreachable until manually turned on again.")) {
                fetch('/api/system/shutdown', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        // Check if redirected to login
                        if (response.redirected || response.url.includes('/login')) {
                            throw new Error('Session expired. Please refresh and login again.');
                        }
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        // Check content type before parsing
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            throw new Error('Invalid response from server (not JSON)');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            alert("Shutdown initiated. System will power off in a few seconds.");
                        } else {
                            alert("Shutdown failed: " + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Shutdown error:', error);
                        alert("Shutdown failed: " + error.message);
                    });
            }
        }

        function confirmRestart() {
            if (confirm("Are you sure you want to RESTART the Raspberry Pi? The system will be unavailable for about a minute.")) {
                fetch('/api/system/restart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        // Check if redirected to login
                        if (response.redirected || response.url.includes('/login')) {
                            throw new Error('Session expired. Please refresh and login again.');
                        }
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        // Check content type before parsing
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            throw new Error('Invalid response from server (not JSON)');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            alert("Restart initiated. Please refresh the page in a minute.");
                        } else {
                            alert("Restart failed: " + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Restart error:', error);
                        alert("Restart failed: " + error.message);
                    });
            }
        }

    </script>

    <!-- System Information (Dynamic) -->
    <h4 class="mt-5 mb-3">System Information</h4>
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3" id="sysInfoContainer">
                <div class="col-6 col-md-3">
                    <small class="text-muted d-block">WatchMyBirds</small>
                    <span class="fw-bold" id="si-app">Loading...</span>
                </div>
                <div class="col-6 col-md-3">
                    <small class="text-muted d-block">Kernel</small>
                    <span class="font-monospace" id="si-kernel">Loading...</span>
                </div>
                <div class="col-6 col-md-3">
                    <small class="text-muted d-block">OS</small>
                    <span class="font-monospace" id="si-os">Loading...</span>
                </div>
                <div class="col-6 col-md-3">
                    <small class="text-muted d-block">Bootloader</small>
                    <span class="font-monospace" id="si-boot">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- System Settings (Read-Only) -->
    <h4 class="mt-5 mb-3">System Settings (Read-only)</h4>
    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Key</th>
                    <th>Value</th>
                    <th>Default</th>
                    <th>Source</th>
                    <th>Restart</th>
                </tr>
            </thead>
            <tbody>
                {% for key in system_keys %}
                {% if key in payload %}
                <tr>
                    <td>{{ labels.get(key, key) }}</td>
                    <td><code>{{ payload[key].value }}</code></td>
                    <td><span class="text-muted">{{ payload[key].default }}</span></td>
                    <td><span class="badge bg-secondary">{{ payload[key].source }}</span></td>
                    <td>{{ "Yes" if payload[key].restart_required else "No" }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>


    <!-- Danger Zone (Shutdown) -->
    <div class="card mb-4 border-danger">
        <div class="card-header bg-danger text-white fw-bold">Danger Zone</div>
        <div class="card-body">

            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <p class="mb-0">System Power Management</p>
                    <small class="text-muted">Safely restart or shut down the Raspberry Pi.</small>
                </div>
                <div class="d-flex flex-column align-items-end">
                    <span class="badge bg-warning text-dark mb-1">MAINTENANCE</span>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-warning" onclick="confirmRestart()">
                            Restart
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="confirmShutdown()">
                            Shutdown
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
